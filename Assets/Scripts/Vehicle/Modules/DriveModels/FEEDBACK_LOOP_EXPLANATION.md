# Объяснение обратной связи в системе двигателя

## Общая концепция

В реальном автомобиле существует **двусторонняя связь** между двигателем и колесами:
- **Прямая связь**: Двигатель крутит колеса через коробку передач
- **Обратная связь**: Колеса "крутят" двигатель через коробку передач (если сцепление включено)

Это создает **замкнутый контур** (feedback loop), где двигатель и колеса влияют друг на друга.

---

## Как это работает в нашей системе

### Шаг 1: Throttle → Желаемый engineRPM

Когда вы нажимаете на газ:
```
Throttle (0-1) → desiredEngineRPM
```

**Пример:**
- Throttle = 0.5 (50% газа)
- idleRPM = 800, maxRPM = 6500
- desiredEngineRPM = 800 + (6500 - 800) × 0.5 = **3650 RPM**

**Важно:** Это желание двигателя, но не факт! Двигатель не может мгновенно достичь этого RPM.

---

### Шаг 2: Скорость → Фактический engineRPM (ОБРАТНАЯ СВЯЗЬ)

Текущая скорость машины определяет, какой RPM **должен быть** у двигателя, если он напрямую связан с колесами:

```
Скорость → wheelAngularVelocity → actualEngineRPM
```

**Формулы:**
1. `wheelAngularVelocity = speed / wheelRadius` (рад/с)
2. `actualEngineRPM = (wheelAngularVelocity × gearRatio × finalDriveRatio × 60) / (2π)`

**Пример:**
- Скорость = 10 м/с
- wheelRadius = 0.3 м
- gearRatio = 3.5 (1-я передача)
- finalDriveRatio = 3.9

**Расчет:**
1. wheelAngularVelocity = 10 / 0.3 = **33.3 рад/с**
2. actualEngineRPM = (33.3 × 3.5 × 3.9 × 60) / (2π) ≈ **4337 RPM**

**Важно:** Это физическое ограничение! Если машина едет со скоростью 10 м/с на 1-й передаче, двигатель **не может** крутиться медленнее 4337 RPM (если сцепление включено).

---

### Шаг 3: Баланс между желаемым и фактическим

Система выбирает **целевой engineRPM** как максимум из двух:

```
targetEngineRPM = Max(actualEngineRPM, desiredEngineRPM)
```

**Сценарий 1: Стоим на месте (speed = 0)**
- actualEngineRPM = 0 (колеса не крутятся)
- desiredEngineRPM = 3650 (50% газа)
- **targetEngineRPM = 3650** ← Используем желаемый

**Сценарий 2: Едем медленно (speed = 5 м/с)**
- actualEngineRPM = 2168 (физическое ограничение от скорости)
- desiredEngineRPM = 3650 (50% газа)
- **targetEngineRPM = 3650** ← Используем желаемый (можем "перекрутить" двигатель)

**Сценарий 3: Едем быстро (speed = 20 м/с)**
- actualEngineRPM = 8674 (физическое ограничение)
- desiredEngineRPM = 3650 (50% газа)
- **targetEngineRPM = 8674** ← Используем фактический (не можем крутиться медленнее!)

**Сценарий 4: Полный газ на высокой скорости**
- actualEngineRPM = 8674 (от скорости)
- desiredEngineRPM = 6500 (100% газа = maxRPM)
- **targetEngineRPM = 8674** ← Фактический больше желаемого!

---

### Шаг 4: Инерция двигателя

Двигатель не может мгновенно изменить RPM. Используем плавную интерполяцию:

```
_currentEngineRPM = Lerp(_currentEngineRPM, targetEngineRPM, rpmInertia × dt)
```

**Пример:**
- Текущий RPM = 2000
- Целевой RPM = 5000
- rpmInertia = 10
- dt = 0.02 с

**Расчет:**
- Скорость изменения = 10 × 0.02 = 0.2 (20% за кадр)
- Новый RPM = 2000 + (5000 - 2000) × 0.2 = **2600 RPM**

---

### Шаг 5: engineRPM → Крутящий момент → Сила

Из текущего engineRPM рассчитываем мощность и крутящий момент:

```
engineRPM → torque (по кривой) → wheelTorque → wheelForce
```

**Формулы:**
1. `torque = maxTorque × torqueCurve(RPM) × throttle`
2. `wheelTorque = torque × gearRatio × finalDriveRatio`
3. `wheelForce = wheelTorque / wheelRadius`

**Пример:**
- engineRPM = 4000
- torqueCurve(4000) = 0.8 (из кривой)
- maxTorque = 155 Нм
- throttle = 0.5
- gearRatio = 3.5
- finalDriveRatio = 3.9
- wheelRadius = 0.3 м

**Расчет:**
1. torque = 155 × 0.8 × 0.5 = **62 Нм**
2. wheelTorque = 62 × 3.5 × 3.9 = **846.3 Нм**
3. wheelForce = 846.3 / 0.3 = **2821 Н**

---

### Шаг 6: Сила → Ускорение → Скорость

Применяем силу к Rigidbody:

```
wheelForce → AddForce() → ускорение → новая скорость
```

Unity физика автоматически обновляет скорость машины.

---

### Шаг 7: Новая скорость → Новая обратная связь

Новая скорость снова влияет на actualEngineRPM (шаг 2), и цикл повторяется!

---

## Визуализация цикла

```
┌─────────────────────────────────────────────────────────┐
│                    ОБРАТНАЯ СВЯЗЬ                        │
└─────────────────────────────────────────────────────────┘

    Throttle
      ↓
[Желаемый engineRPM]
      ↓
[Баланс: Max(желаемый, фактический)]
      ↓
[Текущий engineRPM с инерцией]
      ↓
[Крутящий момент] → [Крутящий момент на колесе] → [Сила]
      ↓
[Ускорение] → [Новая скорость]
      ↓
[Фактический engineRPM] ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ←
      ↑                                                      │
      └──────────────────────────────────────────────────────┘
                    ОБРАТНАЯ СВЯЗЬ
```

---

## Ключевые моменты

### 1. Почему нужна обратная связь?

**Без обратной связи:**
- Двигатель крутится на желаемых оборотах
- Но если машина уже едет быстро, двигатель не может крутиться медленнее (физическое ограничение)
- Система становится нереалистичной

**С обратной связью:**
- Двигатель учитывает текущую скорость
- На высокой скорости двигатель не может "замедлиться" ниже физического минимума
- Система реалистична

### 2. Когда обратная связь важна?

**На низкой скорости:**
- actualEngineRPM низкий
- desiredEngineRPM может быть высоким (газ в пол)
- Система использует желаемый RPM → машина ускоряется

**На высокой скорости:**
- actualEngineRPM высокий (от скорости)
- desiredEngineRPM может быть низким (отпустили газ)
- Система использует фактический RPM → двигатель "тормозит" машину

### 3. Что происходит при переключении передачи?

**До переключения (1-я передача, gearRatio = 3.5):**
- speed = 10 м/с
- actualEngineRPM = 4337 RPM

**После переключения (2-я передача, gearRatio = 2.0):**
- speed = 10 м/с (пока не изменилась)
- actualEngineRPM = (10 / 0.3 × 2.0 × 3.9 × 60) / (2π) ≈ **2478 RPM**

**Результат:**
- RPM падает (меньше передаточное число)
- Но желаемый RPM может быть высоким (газ в пол)
- Система снова балансирует между желаемым и фактическим

---

## Примеры работы системы

### Пример 1: Трогание с места

**Начальное состояние:**
- speed = 0 м/с
- throttle = 1.0 (газ в пол)
- gear = 1

**Шаг 1:**
- actualEngineRPM = 0 (стоим)
- desiredEngineRPM = 6500 (газ в пол)
- targetEngineRPM = 6500

**Шаг 2:**
- engineRPM плавно растет (инерция) → 2000 → 3000 → 4000...
- torque растет → wheelForce растет
- Машина начинает двигаться

**Шаг 3:**
- speed = 1 м/с
- actualEngineRPM = 433 RPM (от скорости)
- desiredEngineRPM = 6500 (все еще газ в пол)
- targetEngineRPM = 6500 (используем желаемый)

**Шаг 4:**
- engineRPM продолжает расти → 5000 → 6000 → 6500
- Сила максимальная
- Машина ускоряется

### Пример 2: Движение на высокой скорости

**Состояние:**
- speed = 30 м/с (108 км/ч)
- throttle = 0.3 (легкий газ)
- gear = 5 (gearRatio = 0.8)

**Расчет:**
- actualEngineRPM = (30 / 0.3 × 0.8 × 3.9 × 60) / (2π) ≈ **2976 RPM**
- desiredEngineRPM = 800 + (6500 - 800) × 0.3 = **2510 RPM**
- targetEngineRPM = Max(2976, 2510) = **2976 RPM**

**Результат:**
- Система использует фактический RPM (2976)
- Двигатель "крутится" быстрее, чем хотелось бы (2510)
- Это физическое ограничение - нельзя крутиться медленнее при такой скорости

### Пример 3: Отпустили газ на высокой скорости

**Состояние:**
- speed = 30 м/с
- throttle = 0.0 (отпустили газ)
- gear = 5

**Расчет:**
- actualEngineRPM = 2976 RPM (от скорости)
- desiredEngineRPM = 800 RPM (idle, так как throttle = 0)
- targetEngineRPM = Max(2976, 800) = **2976 RPM**

**Результат:**
- Двигатель все еще крутится на 2976 RPM (физическое ограничение)
- Но torque = 0 (throttle = 0)
- Сила = 0 → машина замедляется (аэродинамика, трение)

---

## Заключение

Обратная связь - это **физическое ограничение**, которое не позволяет двигателю крутиться медленнее, чем требует текущая скорость машины. Это делает систему реалистичной и физически корректной.

**Ключевая формула обратной связи:**
```
actualEngineRPM = (speed / wheelRadius × gearRatio × finalDriveRatio × 60) / (2π)
```

Эта формула связывает скорость машины с оборотами двигателя через коробку передач, создавая замкнутый контур управления.

